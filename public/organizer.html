<!DOCTYPE html>
<html>
<head>
  <title>Organizer Panel</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #111; color: #fff; }
    input, button { padding: 8px; margin: 6px 0; }
    .box { border: 1px solid #444; padding: 12px; margin-top: 20px; }
    .round-item { padding: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { text-align: center; }

  </style>
</head>
<body>
<h2>Organizer Panel</h2>

<div>
  <label>Your Name:</label>
  <input id="organizerName">
  <button onclick="createRoom()">Create Room</button>
</div>

<div class="box" id="roomInfo" style="display:none;">
  <p>Room Code: <b id="roomCode"></b></p>

  <h3>Add Round</h3>
  <textarea id="roundText" rows="4" cols="40" placeholder="Custom text here..."></textarea><br>
  <input id="duration" type="number" placeholder="Duration Seconds">
  <button onclick="addRound()">Add Round</button>

  <h3>Rounds</h3>
  <div id="roundList"></div>

  <h3>Participants Live</h3>
  <div id="participantsList"></div>
</div>
<h3>Live Leaderboard</h3>
<h3>Round Timer: <span id="timer">--</span> sec</h3>

<table id="leaderboard" border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Name</th>
      <th>WPM</th>
      <th>Accuracy</th>
      <th>Backspaces</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io("http://localhost:4000"); // âœ… required connection

let roomCode = "";
let roomId = "";
let rounds = [];
let participantStats = {}; // store live stats keyed by participantId
let timerInterval;

/* ---------------- CREATE ROOM ---------------- */
async function createRoom() {
  const res = await fetch("/api/create-room", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ organizerName: organizerName.value })
  });
  const data = await res.json();
  roomCode = data.roomCode;
  roomId = data.roomId;

  document.getElementById("roomCode").textContent = roomCode;
  document.getElementById("roomInfo").style.display = "block";

  socket.emit("joinRoom", { roomCode, participantId: "organizer" });
}

/* ---------------- ADD ROUND ---------------- */
async function addRound() {
  const res = await fetch("/api/add-round", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      roomId,
      customText: roundText.value,
      durationSeconds: duration.value,
      roundNumber: rounds.length + 1
    })
  });
  const newRound = await res.json();
  rounds.push(newRound);
  updateRoundList();
}

/* ---------------- DISPLAY ROUNDS ---------------- */
function updateRoundList() {
  roundList.innerHTML = "";
  rounds.forEach((r, i) => {
    roundList.innerHTML += `
      <div class="round-item">
        Round ${i+1} 
        <button onclick="startRound(${i+1})">Start Round</button>
      </div>`;
  });
}

/* ---------------- START ROUND ---------------- */
function startRound(roundNumber) {
  const round = rounds[roundNumber - 1];
  socket.emit("startRound", { 
    roomCode, 
    roundNumber,
    duration: round.durationSeconds 
  });
}

/* ---------------- LIVE TIMER UI ---------------- */
socket.on("roundStarted", ({ roundNumber, duration }) => {
  let timeLeft = duration;
  document.getElementById("timer").textContent = timeLeft;

  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").textContent = timeLeft;

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      socket.emit("endRound", { roomCode });
    }
  }, 1000);
});

socket.on("roundEnded", () => {
  document.getElementById("timer").textContent = "Finished";
});

/* ---------------- LIVE PARTICIPANT JOIN ---------------- */
socket.on("participantJoined", (p) => {
  participantsList.innerHTML += `<div data-id="${p.id}">${p.name}</div>`;
});

/* ---------------- LIVE SCORE STREAM ---------------- */
socket.on("liveUpdate", async (data) => {
  const { participantId, correctChars, incorrectChars, backspaceCount } = data;

  const totalTyped = correctChars + incorrectChars;
  const wpm = Math.round((totalTyped / 5));
  const accuracy = totalTyped > 0 
    ? Math.round((correctChars / totalTyped) * 100)
    : 100;

  participantStats[participantId] = {
    name: getParticipantName(participantId),
    wpm,
    accuracy,
    backspace: backspaceCount
  };

  renderLeaderboard();
});

function getParticipantName(id) {
  const el = document.querySelector(`[data-id="${id}"]`);
  return el ? el.textContent : "Player";
}

function renderLeaderboard() {
  const tbody = document.querySelector("#leaderboard tbody");
  tbody.innerHTML = "";

  const sorted = Object.values(participantStats).sort((a, b) => b.wpm - a.wpm);

  sorted.forEach(s => {
    tbody.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.wpm}</td>
        <td>${s.accuracy}%</td>
        <td>${s.backspace}</td>
      </tr>`;
  });
}
</script>

</body>
</html>
