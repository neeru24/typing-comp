<!DOCTYPE html>
<html>
<head>
  <title>Typing Test</title>
  <style>
    body { font-family: Arial; background: #111; color: #fff; padding: 20px; }
    input, button { padding: 8px; margin: 6px 0; }
    #textDisplay { margin-top: 20px; font-size: 22px; line-height: 35px; }
    #textDisplay span.correct { color: #4caf50; }
    #textDisplay span.incorrect { color: #f44336; }
    #timer { font-size: 22px; margin-top: 15px; }
  </style>
</head>
<body>

<h2>Join Room</h2>
<input id="name" placeholder="Your Name">
<input id="roomCode" placeholder="Room Code">
<button onclick="joinRoom()">Join</button>

<div id="testArea" style="display:none;">
  <h3>Round Running...</h3>
  <h3>Time Left: <span id="timer">--</span> sec</h3>
  <div id="textDisplay"></div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io("http://localhost:4000");

let participantId = localStorage.getItem("participantId");
let roundText = "";
let progressIndex = 0;
let correctChars = 0;
let incorrectChars = 0;
let backspaceCount = 0;
let typingEnabled = false;

/* ---------------- JOIN ROOM ---------------- */
async function joinRoom() {
  const res = await fetch("/api/join-room", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ name: name.value, roomCode: roomCode.value })
  });

  const data = await res.json();
  participantId = data.participantId;
  localStorage.setItem("participantId", participantId);

  socket.emit("joinRoom", { roomCode: roomCode.value, participantId });
}

/* ---------------- START ROUND EVENT ---------------- */
socket.on("roundStarted", async ({ roundNumber, duration }) => {
  typingEnabled = true;
  progressIndex = 0;
  correctChars = 0;
  incorrectChars = 0;
  backspaceCount = 0;

  document.getElementById("testArea").style.display = "block";

  // Load text
  const res = await fetch("/api/get-round-text?roomCode=" + roomCode.value + "&roundNumber=" + roundNumber);
  const data = await res.json();
  roundText = data.customText;
  displayText();

  // Start Timer
  let timeLeft = duration;
  document.getElementById("timer").textContent = timeLeft;

  const countdown = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").textContent = timeLeft;

    if (timeLeft <= 0) {
      typingEnabled = false;
      clearInterval(countdown);
      socket.emit("endRound", { roomCode: roomCode.value });
    }
  }, 1000);
});

/* ---------------- DISPLAY TEXT ---------------- */
function displayText() {
  textDisplay.innerHTML = "";
  roundText.split("").forEach(c => {
    const span = document.createElement("span");
    span.textContent = c;
    textDisplay.appendChild(span);
  });
}

/* ---------------- TYPING LOGIC ---------------- */
document.addEventListener("keydown", (e) => {
  if (!typingEnabled) return;

  const spans = textDisplay.querySelectorAll("span");
  const expected = spans[progressIndex]?.textContent;
  if (!expected) return;

  if (e.key === "Backspace") {
    if (progressIndex > 0) {
      progressIndex--;
      backspaceCount++;
      spans[progressIndex].classList.remove("correct", "incorrect");
    }
    saveProgress();
    return;
  }

  if (e.key.length === 1) {
    if (e.key === expected) {
      spans[progressIndex].classList.add("correct");
      correctChars++;
    } else {
      spans[progressIndex].classList.add("incorrect");
      incorrectChars++;
    }
    progressIndex++;
    saveProgress();
  }
});

/* ---------------- SEND LIVE UPDATE ---------------- */
function saveProgress() {
  socket.emit("typingProgress", {
    roomCode: roomCode.value,
    participantId,
    correctChars,
    incorrectChars,
    backspaceCount,
    progressIndex
  });
}

/* ---------------- STOP TYPING WHEN ROUND ENDS ---------------- */
socket.on("roundEnded", () => {
  typingEnabled = false;
  document.getElementById("timer").textContent = "Finished";
});
</script>

</body>
</html>
